

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>crossValidate &mdash; SOAP 0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="SOAP 0.1 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">SOAP 0.1 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for crossValidate</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   SOAP cross vailiation and bayesian predictive densitites module.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">scorer</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sampling</span> <span class="kn">import</span> <span class="o">*</span>


<span class="k">class</span> <span class="nc">k2cv</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">spsfo</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="p">[]):</span>
        <span class="k">if</span> <span class="n">model</span><span class="p">:</span>
            <span class="n">so</span><span class="o">=</span><span class="n">scorer</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
            <span class="n">spsfo</span><span class="o">=</span><span class="n">optimizer</span><span class="p">(</span><span class="n">scorer</span><span class="o">=</span><span class="n">so</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">spsfo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ospsfo</span><span class="o">=</span><span class="n">spsfo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">=</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">model</span>
        <span class="k">if</span> <span class="n">spsfo</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="o">=</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">get_sample</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nots</span><span class="o">=</span><span class="mi">2</span>

        
    <span class="k">def</span> <span class="nf">partfunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">osample</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
        <span class="n">sample</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">osample</span><span class="p">)</span>
        <span class="n">sl</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span><span class="o">/</span><span class="n">k</span>
        <span class="n">re</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span><span class="o">%</span><span class="n">k</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">1234</span><span class="p">)</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
        <span class="n">ci</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">samplelist</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">re</span><span class="p">:</span>
                <span class="n">ll</span><span class="o">=</span><span class="n">sl</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ll</span><span class="o">=</span><span class="n">sl</span>
            <span class="n">samplelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="n">ci</span><span class="p">:</span><span class="n">ci</span><span class="o">+</span><span class="n">ll</span><span class="p">])</span>
            <span class="n">ci</span><span class="o">=</span><span class="n">ci</span><span class="o">+</span><span class="n">ll</span>
        <span class="k">return</span> <span class="n">samplelist</span>
    
    <span class="k">def</span> <span class="nf">evalfunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sample</span><span class="p">,</span><span class="n">parvalue</span><span class="p">):</span>
        <span class="c">#model should be a dictionary defines the type of the model,the parameters, the initial value of parameters, the value range</span>
        <span class="c">#model={type:;par:;parvalue:;parrange:;parsearchbins:;}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sample</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testscorer</span>
        <span class="n">validationresult</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">calc_score_point</span><span class="p">(</span><span class="n">parvalue</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">validationresult</span>
    
    <span class="k">def</span> <span class="nf">trainfunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sample</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ospsfo</span><span class="o">.</span><span class="n">scorer</span><span class="p">)</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">testscorer</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">get_ds_part</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
        <span class="n">trainresulttask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">multi_optimizer_cluster</span><span class="p">()</span><span class="c">#nspo.optimize()[0:2]#</span>
        <span class="k">return</span> <span class="n">trainresulttask</span>

    <span class="k">def</span> <span class="nf">process_cv_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">resultlist</span><span class="p">):</span>
        <span class="n">aresult</span><span class="o">=</span><span class="p">[]</span>
<span class="c">#        pdb.set_trace()</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">resultlist</span><span class="p">:</span>
                <span class="n">tperc</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">perc</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tperc</span><span class="o">=</span><span class="n">tperc</span><span class="o">+</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">perc</span><span class="o">=</span><span class="n">perc</span><span class="o">+</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                        <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
                <span class="n">tperc</span><span class="o">=</span><span class="n">tperc</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="n">perc</span><span class="o">=</span><span class="n">perc</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="n">aresult</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">tperc</span><span class="p">,</span><span class="n">perc</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">aresult</span>
                    
    <span class="k">def</span> <span class="nf">pickfunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cvresult</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">cross_validation_single_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">input</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">trainedresulttask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trainfunc</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">tasklist</span><span class="p">(</span><span class="n">tasklist</span><span class="o">=</span><span class="p">[</span><span class="n">trainedresulttask</span><span class="p">],</span><span class="n">afterprocessing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">single_run_after_processing</span><span class="p">,</span><span class="n">other</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        
    <span class="k">def</span> <span class="nf">single_run_after_processing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">trainedresult</span><span class="p">,</span><span class="n">tasklist</span><span class="o">=</span><span class="p">[],</span><span class="n">other</span><span class="o">=</span><span class="p">[]):</span>
        <span class="n">testresult</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">evalfunc</span><span class="p">(</span><span class="n">other</span><span class="p">,</span><span class="n">trainedresult</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">trainedresult</span><span class="p">,</span><span class="n">testresult</span><span class="p">]</span>
        
    <span class="k">def</span> <span class="nf">cross_validation_single_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">input</span><span class="p">):</span>
        <span class="n">k</span><span class="o">=</span><span class="nb">input</span><span class="p">[</span><span class="s">&#39;k&#39;</span><span class="p">]</span>
        <span class="n">sample</span><span class="o">=</span><span class="nb">input</span><span class="p">[</span><span class="s">&#39;sample&#39;</span><span class="p">]</span>
        <span class="n">testsample</span><span class="o">=</span><span class="nb">input</span><span class="p">[</span><span class="s">&#39;testsample&#39;</span><span class="p">]</span>
        <span class="n">modellist</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">resultlist</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">trainresultlist</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">inputlist</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">):</span>
            <span class="n">samplelist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">partfunc</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="n">inputlist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">samplelist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">samplelist</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">inputlist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">samplelist</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">samplelist</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">inputlist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">sample</span><span class="p">,</span><span class="n">testsample</span><span class="p">])</span>
        <span class="c">#if self.spsfo.scorer.model[&#39;cvm&#39;].startswith(&#39;parallel&#39;):</span>
        <span class="c">#    srtask=task(self.env).parallel_local_withreturn(self.cross_validation_single_run,inputlist,len(inputlist))</span>
        <span class="c">#else:</span>
        <span class="n">srtask</span><span class="o">=</span><span class="n">task</span><span class="p">()</span><span class="o">.</span><span class="n">serial_local</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cross_validation_single_run</span><span class="p">,</span><span class="n">inputlist</span><span class="p">)</span><span class="c">#parallel_local_withreturn,10</span>
        <span class="k">return</span> <span class="n">tasklist</span><span class="p">(</span><span class="n">tasklist</span><span class="o">=</span><span class="n">srtask</span><span class="p">)</span>    
    
    <span class="k">def</span> <span class="nf">get_test_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sample</span><span class="p">,</span><span class="n">testperc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">testsample</span><span class="o">=</span><span class="p">[]):</span>
        <span class="k">if</span> <span class="n">testperc</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">get_sample</span><span class="p">(</span><span class="n">perc</span><span class="o">=</span><span class="n">testperc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trainsample</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sample</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">testsample</span><span class="p">:</span>
                    <span class="n">trainsample</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">testsample</span><span class="p">,</span><span class="n">trainsample</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">cross_validation_with_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">testsample</span><span class="o">=</span><span class="p">[],</span><span class="n">testperc</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span>
        <span class="c">#should call this function to do cross validation under every circustance</span>
        <span class="n">testsample</span><span class="p">,</span><span class="n">trainsample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_test_sample</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="n">testperc</span><span class="p">,</span><span class="n">testsample</span><span class="p">)</span>
        <span class="nb">input</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;k&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;cvk&#39;</span><span class="p">],</span><span class="s">&#39;sample&#39;</span><span class="p">:</span><span class="n">sample</span><span class="p">,</span><span class="s">&#39;testsample&#39;</span><span class="p">:</span><span class="n">testsample</span><span class="p">}</span>
        <span class="n">srtask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cross_validation_single_model</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testsample</span><span class="o">=</span><span class="n">testsample</span>
        <span class="k">return</span> <span class="n">tasklist</span><span class="p">(</span><span class="n">tasklist</span><span class="o">=</span><span class="p">[</span><span class="n">srtask</span><span class="p">],</span><span class="n">afterprocessing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">analyze_cv</span><span class="p">)</span> 
        
    <span class="k">def</span> <span class="nf">analyze_cv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rresultlist</span><span class="p">,</span><span class="n">tasklist</span><span class="o">=</span><span class="p">[],</span><span class="n">other</span><span class="o">=</span><span class="p">[]):</span>
        <span class="n">resultlist</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">testresult</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">rresultlist</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">testresult</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">trainresult</span><span class="o">=</span><span class="n">result</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">resultlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trainresult</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">resultlist</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">process_cv_result</span><span class="p">(</span><span class="n">resultlist</span><span class="p">),</span> <span class="n">testresult</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">load_optarraylist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">path</span><span class="p">):</span>
        <span class="n">cr</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s">&#39;cvresult.mat&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optarraylist</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">rk</span><span class="o">=</span><span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cr</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">rk</span><span class="p">)):</span>
            <span class="n">key</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">na</span><span class="o">=</span><span class="n">cr</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">nref</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">na</span><span class="p">)):</span>
                <span class="n">nref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">na</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">nref</span><span class="o">=</span><span class="n">squeeze_list</span><span class="p">(</span><span class="n">nref</span><span class="p">)</span>
            <span class="n">na</span><span class="o">=</span><span class="n">list2array</span><span class="p">(</span><span class="n">nref</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optarraylist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">na</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">combine_optimization_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">optresultlist</span><span class="p">):</span>
        <span class="c">#analyze the best result from different runs</span>
        <span class="n">na</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">optresultlist</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">optresultlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
        <span class="n">optarraylist</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">optresultlist</span><span class="p">)):</span>
            <span class="n">item</span><span class="o">=</span><span class="n">optresultlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)):</span>
                <span class="n">na</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="n">j</span><span class="p">][:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">optarraylist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optarraylist</span><span class="o">=</span><span class="n">optarraylist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optstats</span><span class="o">=</span><span class="n">na</span>
        <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">optstats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statsstr</span><span class="o">=</span><span class="s">&#39;(&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optstats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">+</span><span class="s">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optstats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">+</span><span class="s">&#39;) &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optstats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">+</span><span class="s">u&quot;</span><span class="se">\u00B1</span><span class="s">&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optstats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">get_scorer_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&#39;filter&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
            <span class="n">fl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;filter&#39;</span><span class="p">]</span>
            <span class="n">cvmodel</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">fl</span><span class="p">[</span><span class="s">&#39;filterpath&#39;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cvmodel</span><span class="p">[</span><span class="s">&#39;allresult&#39;</span><span class="p">])</span><span class="o">!=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputlist</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;The model filter can not be applied to this  cv case, number of tries different&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scorerlist</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputlist</span><span class="p">)):</span>
            <span class="n">scorer1</span><span class="p">,</span><span class="n">scorer2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">get_ds_part</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputlist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;filter&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> 
                <span class="n">scorer1</span><span class="o">.</span><span class="n">loadfilter</span><span class="o">=</span><span class="p">[{</span><span class="s">&#39;criteria&#39;</span><span class="p">:</span><span class="n">fl</span><span class="p">[</span><span class="s">&#39;criteria&#39;</span><span class="p">],</span><span class="s">&#39;parvalue&#39;</span><span class="p">:</span><span class="n">cvmodel</span><span class="p">[</span><span class="s">&#39;allresult&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;bestpar&#39;</span><span class="p">]}]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scorerlist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">scorer1</span><span class="p">,</span><span class="n">scorer2</span><span class="p">])</span>
            
    <span class="k">def</span> <span class="nf">clustering_optimization_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">parlist</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">resultlist</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">optarray</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">optarraylist</span><span class="p">:</span>
            <span class="n">ra</span><span class="p">,</span><span class="n">nay</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">get_rrf</span><span class="p">(</span><span class="n">optarray</span><span class="p">)</span>
            <span class="n">parlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span>
            <span class="n">resultlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nay</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">=</span><span class="n">cvclustering</span><span class="p">(</span><span class="n">parlist</span><span class="p">,</span><span class="n">resultlist</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">scorerlist</span><span class="p">,</span><span class="n">clustermethod</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;clustermethod&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">analyze</span><span class="p">()</span>

        <span class="n">sd</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;lastone&#39;</span><span class="p">:</span><span class="n">lastone</span><span class="p">,</span><span class="s">&#39;parlist&#39;</span><span class="p">:</span><span class="n">parlist</span><span class="p">,</span><span class="s">&#39;resultlist&#39;</span><span class="p">:</span><span class="n">resultlist</span><span class="p">,</span><span class="s">&#39;testresultlist&#39;</span><span class="p">:</span><span class="n">testresultlist</span><span class="p">,</span>
            <span class="s">&#39;bestpar&#39;</span><span class="p">:</span><span class="n">bestpar</span><span class="p">,</span> <span class="s">&#39;bestresult&#39;</span><span class="p">:</span><span class="n">resultlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&#39;testresult&#39;</span><span class="p">:</span><span class="n">testscorer</span><span class="o">.</span><span class="n">assess</span><span class="p">(</span><span class="n">bestpar</span><span class="p">),</span>
            <span class="s">&#39;fulltestresult&#39;</span><span class="p">:</span><span class="n">testscorer</span><span class="o">.</span><span class="n">assess</span><span class="p">(</span><span class="n">bestpar</span><span class="p">,</span><span class="n">report</span><span class="o">=</span><span class="s">&#39;full&#39;</span><span class="p">),</span>
            <span class="s">&#39;pd&#39;</span><span class="p">:</span><span class="n">pd</span><span class="o">/</span><span class="n">k</span><span class="p">,</span><span class="s">&#39;rlpd&#39;</span><span class="p">:</span><span class="n">rlpd</span><span class="p">}</span>      
        
    <span class="k">def</span> <span class="nf">analyze_clustering_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withlastone</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finaloptresult</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;bestresult&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finaloptpar</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;bestpar&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;finalbestresult&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">finalfinaloptresult</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;finalbestresult&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">finalfinaltestresult</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;finaltestresult&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">finalfinaloptresult</span><span class="o">=</span><span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">finalfinaltestresult</span><span class="o">=</span><span class="mi">0</span>               
            <span class="n">tn</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lasttestresult</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;testresult&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bestmodelresult</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;bestresult&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finaloptresult</span><span class="o">=</span><span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finaloptpar</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">tn</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lasttestresult</span><span class="o">=</span><span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bestmodelresult</span><span class="o">=</span><span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finalfinaloptresult</span><span class="o">=</span><span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finalfinaltestresult</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">optlist</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tn</span><span class="p">)</span>
        <span class="n">testlist</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tn</span><span class="p">)</span>
        <span class="n">finaloptlist</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tn</span><span class="p">)</span>
        <span class="n">finaltestlist</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tn</span><span class="p">)</span>
        <span class="n">pdlist</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tn</span><span class="p">)</span>
        <span class="n">rlpdlist</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tn</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">tn</span><span class="p">):</span>
            <span class="n">optlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;bestresult&#39;</span><span class="p">]</span>
            <span class="n">testlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;testresult&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;finalbestresult&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">finaloptlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;finalbestresult&#39;</span><span class="p">]</span>
                <span class="n">finaltestlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;finaltestresult&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">finaloptlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">finaltestlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>               
            <span class="n">pdlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;pd&#39;</span><span class="p">]</span>
            <span class="n">rlpdlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;rlpd&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optresults</span><span class="o">=</span><span class="n">optlist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testresults</span><span class="o">=</span><span class="n">testlist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optmean</span><span class="o">=</span><span class="n">optlist</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optstd</span><span class="o">=</span><span class="n">optlist</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finaloptmean</span><span class="o">=</span><span class="n">finaloptlist</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finaloptstd</span><span class="o">=</span><span class="n">finaloptlist</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdsum</span><span class="o">=</span><span class="n">pdlist</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rlpdmean</span><span class="o">=</span><span class="n">rlpdlist</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testmean</span><span class="o">=</span><span class="n">testlist</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teststd</span><span class="o">=</span><span class="n">testlist</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finaltestmean</span><span class="o">=</span><span class="n">finaltestlist</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finalteststd</span><span class="o">=</span><span class="n">finaltestlist</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tn</span><span class="p">)</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">resultstr</span><span class="o">=</span><span class="s">u&quot;{5:.5f},{6:.3f}, {0:2.3f}</span><span class="se">\u00B1</span><span class="s">{1:2.3f}, {2:2.3f}</span><span class="se">\u00B1</span><span class="s">{3:2.3f}, {4:2.3f}, {7:2.3f}__{8:2.3f}</span><span class="se">\u00B1</span><span class="s">{9:2.3f}, {10:2.3f}</span><span class="se">\u00B1</span><span class="s">{11:2.3f}, {12:2.3f}, {13:2.3f} &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optmean</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">optstd</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">testmean</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">teststd</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">finaloptresult</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pdsum</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">rlpdmean</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">lasttestresult</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">finaloptmean</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">finaloptstd</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">finaltestmean</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">finalteststd</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">finalfinaloptresult</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">finalfinaltestresult</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resultarray</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">optmean</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">optstd</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">testmean</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">teststd</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">finaloptresult</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pdsum</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">lasttestresult</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">finaloptmean</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">finaloptstd</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">finaltestmean</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">finalteststd</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">finalfinaloptresult</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">finalfinaltestresult</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">rlpdmean</span><span class="p">])</span>
        <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">resultstr</span>
        
    <span class="k">def</span> <span class="nf">save_optimization_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bdir</span><span class="o">=</span><span class="n">runenv</span><span class="o">.</span><span class="n">basedir</span><span class="o">+</span><span class="s">&#39;results/&#39;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">bdir</span><span class="p">)</span>
        <span class="n">tdir</span><span class="o">=</span><span class="n">bdir</span><span class="o">+</span><span class="s">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">bmtype</span><span class="p">[</span><span class="s">&#39;dslist&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">tdir</span><span class="p">)</span>
        <span class="n">tdir</span><span class="o">=</span><span class="n">tdir</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">bmtype</span><span class="p">[</span><span class="s">&#39;criteria&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">tdir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logdir</span><span class="o">=</span><span class="n">tdir</span><span class="o">+</span><span class="s">&#39;/&#39;</span>
        <span class="n">tdir</span><span class="o">=</span><span class="n">tdir</span><span class="o">+</span><span class="s">&#39;/runs/&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">tdir</span><span class="p">)</span>
        <span class="n">cdp</span><span class="o">=</span><span class="n">tdir</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">rundir</span><span class="o">+</span><span class="s">&#39;-&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">resultstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">u&quot;</span><span class="se">\u00B1</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;+&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;/&#39;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">cdp</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cdp</span><span class="p">)</span>
        <span class="c">#self.clusters.figpath=cdp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logpath</span><span class="o">=</span><span class="n">cdp</span>
        <span class="c">#mypickle().dump(self.clusters, &#39;figinput&#39;)</span>
        <span class="n">fh</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;cvmodel.pickle&#39;</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">({</span><span class="s">&#39;model&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">originalmodel</span><span class="p">,</span> <span class="s">&#39;runtime&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">runduration</span><span class="p">,</span>
                     <span class="s">&#39;inputlist&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">inputlist</span><span class="p">,</span><span class="s">&#39;allresult&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="p">,</span><span class="s">&#39;originalresult&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">originalresult</span><span class="p">},</span><span class="n">fh</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c">#self.clusters.dump(&#39;cvcluster.pickle&#39;)</span>
        <span class="k">print</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;cp &#39;</span><span class="o">+</span><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s">&#39; ./&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withlastone</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bestmodel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">build_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finaloptpar</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;bestmodel.pickle&#39;</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bestmodel</span><span class="p">,</span><span class="n">fh</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">fh</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;bestmodel&#39;</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">any2str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bestmodel</span><span class="p">))</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>                    
            <span class="n">fh</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;bestmodelresult&#39;</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bestmodelresult</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;fulltestresult&#39;</span><span class="p">]))</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bestmodel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">originalmodel</span>
            <span class="n">fh</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;bestmodel.pickle&#39;</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bestmodel</span><span class="p">,</span><span class="n">fh</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">fh</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;bestmodel&#39;</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">any2str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bestmodel</span><span class="p">))</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>               
        <span class="bp">self</span><span class="o">.</span><span class="n">write2logshelve</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write2db</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resultstr</span>

    <span class="k">def</span> <span class="nf">plot_bestpar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">par</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">finaloptpar</span>
        <span class="n">bestmodel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bestmodel</span>
        <span class="n">so</span><span class="o">=</span><span class="n">scorer</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">bestmodel</span><span class="p">)</span>
        <span class="n">so</span><span class="o">.</span><span class="n">assess</span><span class="p">(</span><span class="n">par</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">len</span><span class="p">(</span><span class="n">so</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;scorers&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">so</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;scorers&#39;</span><span class="p">][</span><span class="s">&#39;type&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s">&#39;sf&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">sfo</span><span class="o">=</span><span class="n">so</span><span class="o">.</span><span class="n">scorerlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sfo</span><span class="o">.</span><span class="n">sfv</span><span class="p">)</span>   


    <span class="k">def</span> <span class="nf">write2logshelve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">originalmodel</span>        
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logdir</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="s">&quot;log.shelve&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="n">lock</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Lock acquired.&quot;</span><span class="p">)</span>     
            <span class="n">resultdictlog</span><span class="o">=</span><span class="n">shelve</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logdir</span><span class="o">+</span><span class="s">&#39;log.shelve&#39;</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">model</span><span class="p">[</span><span class="s">&#39;str&#39;</span><span class="p">]</span>
            <span class="n">model</span><span class="p">[</span><span class="s">&#39;str&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">any2str</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>  
            <span class="n">resultdictlog</span><span class="p">[</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;str&#39;</span><span class="p">]]</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">resultarray</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">resultstr</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">rundir</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bestmodel</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bestmodelresult</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">logpath</span><span class="p">]</span> 
            <span class="n">resultdictlog</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;lock released&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">modelinlog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">originalmodel</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logdir</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">model</span><span class="p">[</span><span class="s">&#39;str&#39;</span><span class="p">]</span>
        <span class="n">model</span><span class="p">[</span><span class="s">&#39;str&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">any2str</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>        
        <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="s">&quot;log.shelve&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="n">lock</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Lock acquired.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logdir</span><span class="o">+</span><span class="s">&#39;log.shelve&#39;</span><span class="p">):</span>
                <span class="n">nmr</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resultdictlog</span><span class="o">=</span><span class="n">shelve</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logdir</span><span class="o">+</span><span class="s">&#39;log.shelve&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">model</span><span class="p">[</span><span class="s">&#39;str&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">resultdictlog</span><span class="p">:</span>
                    <span class="n">nmr</span><span class="o">=</span><span class="n">resultdictlog</span><span class="p">[</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;str&#39;</span><span class="p">]]</span>
                    <span class="c">#ko=k2cvcluster()</span>
                    <span class="c">#rundirname=[item for item in os.listdir(os.path.join(self.baselogdir,&#39;runs&#39;)) if item.startswith(nmr[2])][0]</span>
                    <span class="c">#ko.load_fromlogdir(os.path.join(self.baselogdir,&#39;runs&#39;,rundirname))</span>
                    <span class="c">#nmr[0]=ko.resultarray</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nmr</span><span class="o">=</span><span class="p">[]</span>
                <span class="n">resultdictlog</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;lock released&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nmr</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resultarray</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">resultstr</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">rundir</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bestmodel</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bestmodelresult</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">logpath</span><span class="o">=</span><span class="n">nmr</span>
            <span class="k">return</span> <span class="bp">True</span>
        
    <span class="k">def</span> <span class="nf">write2db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c">#create the database if non exist</span>
        <span class="kn">import</span> <span class="nn">sqlite3</span>
        <span class="k">class</span> <span class="nc">integerList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">class</span> <span class="nc">textList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">class</span> <span class="nc">realList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">class</span> <span class="nc">anyList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
            <span class="k">pass</span>
        
        <span class="k">def</span> <span class="nf">adapt_slist</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">s</span><span class="p">])</span>


        <span class="k">def</span> <span class="nf">adapt_anylist</span><span class="p">(</span><span class="n">textList</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">textList</span><span class="p">])</span>
        
        <span class="k">def</span> <span class="nf">convert_integerList</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;; &quot;</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">convert_realList</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;; &quot;</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">convert_textList</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;; &quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">convert_anyList</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;; &quot;</span><span class="p">))</span>        
        <span class="n">sqlite3</span><span class="o">.</span><span class="n">register_adapter</span><span class="p">(</span><span class="n">integerList</span><span class="p">,</span> <span class="n">adapt_slist</span><span class="p">)</span>        
        <span class="n">sqlite3</span><span class="o">.</span><span class="n">register_converter</span><span class="p">(</span><span class="s">&quot;integerlist&quot;</span><span class="p">,</span> <span class="n">convert_integerList</span><span class="p">)</span>
        <span class="n">sqlite3</span><span class="o">.</span><span class="n">register_adapter</span><span class="p">(</span><span class="n">realList</span><span class="p">,</span> <span class="n">adapt_slist</span><span class="p">)</span>        
        <span class="n">sqlite3</span><span class="o">.</span><span class="n">register_converter</span><span class="p">(</span><span class="s">&quot;reallist&quot;</span><span class="p">,</span> <span class="n">convert_realList</span><span class="p">)</span>
        <span class="n">sqlite3</span><span class="o">.</span><span class="n">register_adapter</span><span class="p">(</span><span class="n">textList</span><span class="p">,</span> <span class="n">adapt_slist</span><span class="p">)</span>        
        <span class="n">sqlite3</span><span class="o">.</span><span class="n">register_converter</span><span class="p">(</span><span class="s">&quot;textlist&quot;</span><span class="p">,</span> <span class="n">convert_textList</span><span class="p">)</span>
        <span class="n">sqlite3</span><span class="o">.</span><span class="n">register_adapter</span><span class="p">(</span><span class="n">anyList</span><span class="p">,</span> <span class="n">adapt_anylist</span><span class="p">)</span>        
        <span class="n">sqlite3</span><span class="o">.</span><span class="n">register_converter</span><span class="p">(</span><span class="s">&quot;anylist&quot;</span><span class="p">,</span> <span class="n">convert_anyList</span><span class="p">)</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">runenv</span><span class="o">.</span><span class="n">resultdbpath</span><span class="p">,</span><span class="n">detect_types</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">PARSE_DECLTYPES</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="c">#self.optmean,self.optstd,self.testmean,self.teststd,</span>
        <span class="c">#self.finaloptresult,self.lasttestresult,</span>
        <span class="c">#self.finaloptmean,self.finaloptstd,self.finaltestmean,self.finalteststd,</span>
        <span class="c">#self.finalfinaloptresult,self.finalfinaltestresult,</span>
        <span class="c">#self.rlpdmean,self.pdsum,</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;create table if not exists Result (result TEXT,</span>
<span class="s">                     dslist textlist,type TEXT,criteria TEXT, bm TEXT,combine TEXT,</span>
<span class="s">                     filters TEXT, criteria2 TEXT, scorers integerlist, optmethod INTEGER, </span>
<span class="s">                     optmean REAL, optstd REAL,testmean REAL, teststd REAL, finaloptresult REAL,finaltestresult REAL,</span>
<span class="s">                     optmean2 REAL, optstd2 REAL,testmean2 REAL, teststd2 REAL, finaloptresult2 REAL,finaltestresult2 REAL,</span>
<span class="s">                     pdresultmean REAL, pd REAL,bestpar reallist,runnum INTEGER primary key);&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;create table if not exists Scorers (scoind INTEGER, runnum INTEGER)&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;create table if not exists OptMethod (optind INTEGER unique, optmethod TEXT primary key, sml TEXT, cvk INTEGER,</span>
<span class="s">                     repeat INTEGER, testperc REAL,fold INTEGER);&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;create table if not exists Scorer (scoind INTEGER unique, scorer any primary key, type TEXT, features TEXT,</span>
<span class="s">                     sftype TEXT, par TEXT, searchpar TEXT, parvalue TEXT,  searchparvalue TEXT, ratio TEXT,searchratio TEXT,</span>
<span class="s">                     bm TEXT, pdbset TEXT, pm TEXT, genmethod TEXT);&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;create table if not exists Counter (numoptm INTEGER, numsco INTEGER, numres INTEGER)&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">numofcount</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;select count(*) from Counter&quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">numofcount</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;insert into Counter values (1000000,2000000,3000000)&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">numofcount</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;more than 1 line of count&quot;</span>
            <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">m</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">originalmodel</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">originalmodel</span>
        <span class="n">optList</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;sml&#39;</span><span class="p">,</span><span class="s">&#39;cvk&#39;</span><span class="p">,</span><span class="s">&#39;repeat&#39;</span><span class="p">,</span><span class="s">&#39;testperc&#39;</span><span class="p">,</span><span class="s">&#39;fold&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">optList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">optList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">optList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">any2str</span><span class="p">(</span><span class="n">optList</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">optList</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">any2str</span><span class="p">(</span><span class="n">optList</span><span class="p">))</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT *</span>
<span class="s">                        FROM OptMethod</span>
<span class="s">                        WHERE optmethod=?;&quot;&quot;&quot;</span><span class="p">,(</span><span class="n">optList</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
        <span class="n">rows</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;duplicate in database&quot;</span>
            <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">!=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">optList</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot;duplicate but not matching optmethod&quot;</span>
                <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
            <span class="n">optList</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>                
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;update Counter set numoptm=numoptm+1&#39;</span><span class="p">)</span>
            <span class="n">optind</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;Select numoptm from Counter&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">optList</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">optind</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;INSERT INTO OptMethod values (?,?,?,?,?,?,?)&#39;</span><span class="p">,</span><span class="nb">tuple</span><span class="p">(</span><span class="n">optList</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">search</span> <span class="ow">in</span> <span class="n">m</span><span class="p">[</span><span class="s">&#39;searches&#39;</span><span class="p">]:</span>
            <span class="n">search</span><span class="p">[</span><span class="s">&#39;object&#39;</span><span class="p">][</span><span class="n">search</span><span class="p">[</span><span class="s">&#39;key&#39;</span><span class="p">]]</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;search&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">search</span><span class="p">[</span><span class="s">&#39;object&#39;</span><span class="p">][</span><span class="n">search</span><span class="p">[</span><span class="s">&#39;key&#39;</span><span class="p">]]),</span><span class="n">any2str</span><span class="p">(</span><span class="n">search</span><span class="p">[</span><span class="s">&#39;InitialGenerator&#39;</span><span class="p">])]</span>
        <span class="n">allScorers</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">scorer</span> <span class="ow">in</span> <span class="n">m</span><span class="p">[</span><span class="s">&#39;scorers&#39;</span><span class="p">]:</span>
            <span class="n">scoList</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">scoList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">any2str</span><span class="p">(</span><span class="n">scorer</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">,</span><span class="s">&#39;features&#39;</span><span class="p">,</span><span class="s">&#39;sftype&#39;</span><span class="p">,</span><span class="s">&#39;par&#39;</span><span class="p">,</span><span class="s">&#39;parvalue&#39;</span><span class="p">,</span><span class="s">&#39;ratio&#39;</span><span class="p">,</span><span class="s">&#39;bm&#39;</span><span class="p">,</span><span class="s">&#39;pdbset&#39;</span><span class="p">,</span><span class="s">&#39;pm&#39;</span><span class="p">,</span><span class="s">&#39;genmethod&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">scorer</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scorer</span><span class="p">[</span><span class="n">key</span><span class="p">],</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">scorer</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">scorer</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;search&#39;</span><span class="p">:</span>
                        <span class="n">scoList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">any2str</span><span class="p">(</span><span class="n">scorer</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">scoList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scorer</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;par&#39;</span><span class="p">,</span><span class="s">&#39;parvalue&#39;</span><span class="p">,</span><span class="s">&#39;ratio&#39;</span><span class="p">]:</span>
                        <span class="n">scoList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">any2str</span><span class="p">(</span><span class="n">scorer</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
                        <span class="n">scoList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">scoList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">any2str</span><span class="p">(</span><span class="n">scorer</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;par&#39;</span><span class="p">,</span><span class="s">&#39;parvalue&#39;</span><span class="p">,</span><span class="s">&#39;ratio&#39;</span><span class="p">]:</span>
                    <span class="n">scoList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
                    <span class="n">scoList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">scoList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT *</span>
<span class="s">                            FROM Scorer</span>
<span class="s">                            WHERE scorer=?&quot;&quot;&quot;</span><span class="p">,(</span><span class="n">scoList</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
            <span class="n">rows</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;duplicate in database&quot;</span>
                <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">!=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">scoList</span><span class="p">):</span>
                    <span class="k">print</span> <span class="s">&quot;duplicate but not matching scorer&quot;</span>
                    <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
                <span class="n">scoList</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;update Counter set numsco=numsco+1&#39;</span><span class="p">)</span>
                <span class="n">scoind</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;Select numsco from Counter&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">scoList</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">scoind</span><span class="p">)</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;INSERT INTO Scorer values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)&#39;</span><span class="p">,</span><span class="nb">tuple</span><span class="p">(</span><span class="n">scoList</span><span class="p">))</span>
            <span class="n">allScorers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scoList</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">resList</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">resList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">any2str</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
        <span class="n">resList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">textList</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s">&#39;bmtype&#39;</span><span class="p">][</span><span class="s">&#39;dslist&#39;</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">,</span><span class="s">&#39;criteria&#39;</span><span class="p">,</span><span class="s">&#39;bm&#39;</span><span class="p">,</span><span class="s">&#39;combine&#39;</span><span class="p">,</span><span class="s">&#39;filters&#39;</span><span class="p">,</span><span class="s">&#39;finalcriteria&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">m</span><span class="p">[</span><span class="s">&#39;bmtype&#39;</span><span class="p">]:</span>
                <span class="n">resList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">any2str</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s">&#39;bmtype&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">resList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">textList</span><span class="p">(</span><span class="n">allScorers</span><span class="p">))</span>
        <span class="n">resList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">optList</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">resList</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">optmean</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">optstd</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">testmean</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">teststd</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">finaloptresult</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">lasttestresult</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finaloptmean</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">finaloptstd</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">finaltestmean</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">finalteststd</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">finalfinaloptresult</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">finalfinaltestresult</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rlpdmean</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pdsum</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;bestpar&#39;</span><span class="p">],</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rundir</span><span class="p">)])</span>
        <span class="k">if</span>  <span class="nb">isinstance</span><span class="p">(</span><span class="n">resList</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">):</span>
            <span class="n">resList</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">resList</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">resList</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">realList</span><span class="p">(</span><span class="n">resList</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resList</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">nl</span><span class="o">=</span><span class="n">realList</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resList</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])):</span>
                <span class="n">nl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resList</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="n">resList</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">nl</span>
        <span class="k">print</span> <span class="n">resList</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT *</span>
<span class="s">                        FROM Result</span>
<span class="s">                        WHERE runnum=?&quot;&quot;&quot;</span><span class="p">,(</span><span class="n">resList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],))</span>
        <span class="n">rows</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;duplicate in database&quot;</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resList</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">resList</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                        <span class="n">resList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="bp">None</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">!=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">resList</span><span class="p">)[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">or</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">resList</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span><span class="n">resList</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])):</span>
                <span class="k">print</span> <span class="s">&quot;duplicate but not matching result&quot;</span>
                <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="n">allScorers</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;INSERT INTO Scorers values (?,?)&#39;</span><span class="p">,(</span><span class="n">sc</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rundir</span><span class="p">)))</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;INSERT INTO Result values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)&#39;</span><span class="p">,</span><span class="nb">tuple</span><span class="p">(</span><span class="n">resList</span><span class="p">))</span>
        <span class="n">con</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">con</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">k2cvlocal</span><span class="p">(</span><span class="n">k2cv</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">trainfunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sample</span><span class="p">):</span>
        <span class="c">#pdb.set_trace()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ospsfo</span><span class="o">.</span><span class="n">scorer</span><span class="p">)</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">testscorer</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">get_ds_part</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
        <span class="n">trainresult</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">multi_optimizer_local</span><span class="p">()</span><span class="c">#nspo.optimize()[0:2]#</span>
        <span class="k">return</span> <span class="n">trainresult</span>
    
    <span class="k">def</span> <span class="nf">cross_validation_single_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">input</span><span class="p">):</span>
        <span class="n">k</span><span class="o">=</span><span class="nb">input</span><span class="p">[</span><span class="s">&#39;k&#39;</span><span class="p">]</span>
        <span class="n">sample</span><span class="o">=</span><span class="nb">input</span><span class="p">[</span><span class="s">&#39;sample&#39;</span><span class="p">]</span>
        <span class="n">testsample</span><span class="o">=</span><span class="nb">input</span><span class="p">[</span><span class="s">&#39;testsample&#39;</span><span class="p">]</span>
        <span class="n">modellist</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">resultlist</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">trainresultlist</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">inputlist</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">):</span>
            <span class="n">samplelist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">partfunc</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="n">inputlist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">samplelist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">samplelist</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">inputlist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">samplelist</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">samplelist</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">inputlist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">sample</span><span class="p">,</span><span class="n">testsample</span><span class="p">])</span>
        <span class="c">#if self.spsfo.scorer.model[&#39;cvm&#39;].startswith(&#39;parallel&#39;):</span>
        <span class="c">#    srtask=task(runenv).parallel_local_withreturn(self.cross_validation_single_run,inputlist,len(inputlist))</span>
        <span class="c">#else:</span>
        <span class="n">srtask</span><span class="o">=</span><span class="n">task</span><span class="p">()</span><span class="o">.</span><span class="n">serial_local</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cross_validation_single_run</span><span class="p">,</span><span class="n">inputlist</span><span class="p">)</span><span class="c">#parallel_local_withreturn,10</span>
        <span class="k">return</span> <span class="n">srtask</span>   
    
    <span class="k">def</span> <span class="nf">cross_validation_single_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">input</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">trainedresult</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trainfunc</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>            
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_run_after_processing</span><span class="p">(</span><span class="n">trainedresult</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">cross_validation_with_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">testsample</span><span class="o">=</span><span class="p">[],</span><span class="n">testperc</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span>
        <span class="c">#should call this function to do cross validation under every circustance</span>
        <span class="n">testsample</span><span class="p">,</span><span class="n">trainsample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_test_sample</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="n">testperc</span><span class="p">,</span><span class="n">testsample</span><span class="p">)</span>
        <span class="nb">input</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;k&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;cvk&#39;</span><span class="p">],</span><span class="s">&#39;sample&#39;</span><span class="p">:</span><span class="n">sample</span><span class="p">,</span><span class="s">&#39;testsample&#39;</span><span class="p">:</span><span class="n">testsample</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testsample</span><span class="o">=</span><span class="n">testsample</span>
        <span class="n">srtask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cross_validation_single_model</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_cv</span><span class="p">([</span><span class="n">srtask</span><span class="p">])</span>
        
<span class="k">class</span> <span class="nc">k2cvcluster</span><span class="p">(</span><span class="n">k2cvlocal</span><span class="p">):</span> 
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">spsfo</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="p">[],</span> <span class="n">initialize</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">logpath</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">=</span><span class="n">model</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">=</span><span class="n">spsfo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runspernode</span><span class="o">=</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runpath</span><span class="o">=</span><span class="s">&#39;./&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statsstr</span><span class="o">=</span><span class="s">&#39;&#39;</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">testperc</span><span class="o">=-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testsample</span><span class="o">=</span><span class="p">[]</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">rid</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rsn</span><span class="o">=</span><span class="mi">0</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">logpath</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_fromlogdir</span><span class="p">(</span><span class="n">logpath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">initialize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize_model</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">runenv</span><span class="o">.</span><span class="n">hostn</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bdir</span><span class="o">=</span><span class="n">runenv</span><span class="o">.</span><span class="n">basedir</span><span class="o">+</span><span class="s">&#39;results/&#39;</span>
                <span class="n">tdir</span><span class="o">=</span><span class="n">bdir</span><span class="o">+</span><span class="s">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;bmtype&#39;</span><span class="p">][</span><span class="s">&#39;dslist&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tdir</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">tdir</span><span class="p">)</span>
                <span class="n">tdir</span><span class="o">=</span><span class="n">tdir</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;bmtype&#39;</span><span class="p">][</span><span class="s">&#39;criteria&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tdir</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">tdir</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logdir</span><span class="o">=</span><span class="n">tdir</span><span class="o">+</span><span class="s">&#39;/&#39;</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
            
    <span class="k">def</span> <span class="nf">initialize_scorer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">so</span><span class="o">=</span><span class="n">scorer</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">originalmodel</span><span class="p">)</span>
        <span class="n">spsfo</span><span class="o">=</span><span class="n">optimizer</span><span class="p">(</span><span class="n">scorer</span><span class="o">=</span><span class="n">so</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">=</span><span class="n">spsfo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">originalmodel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_cross_validation_sample</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_scorer_list</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">load_fromlogdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lp</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span> <span class="c">#note that repeat is ignored here</span>
        <span class="n">cvmodel</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="s">&#39;cvmodel.pickle&#39;</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="o">=</span><span class="n">cvmodel</span><span class="p">[</span><span class="s">&#39;allresult&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&#39;testperc&#39;</span> <span class="ow">in</span> <span class="n">cvmodel</span><span class="p">[</span><span class="s">&#39;model&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">withlastone</span><span class="o">=</span><span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">withlastone</span><span class="o">=</span><span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">originalmodel</span><span class="o">=</span><span class="n">cvmodel</span><span class="p">[</span><span class="s">&#39;model&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">=</span><span class="bp">None</span>
        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bm</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="s">&#39;bestmodel.pickle&#39;</span><span class="p">)))</span>
            <span class="k">if</span> <span class="s">&#39;repeat&#39;</span> <span class="ow">in</span> <span class="n">bm</span><span class="p">:</span>
                <span class="n">bm</span><span class="p">[</span><span class="s">&#39;repeat&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">so</span><span class="o">=</span><span class="n">scorer</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">bm</span><span class="p">)</span>
            <span class="n">spsfo</span><span class="o">=</span><span class="n">optimizer</span><span class="p">(</span><span class="n">scorer</span><span class="o">=</span><span class="n">so</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">=</span><span class="n">spsfo</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">=</span><span class="n">bm</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize_model</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare_cross_validation_sample</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyze_clustering_results</span><span class="p">()</span>
        <span class="c">#self.rundir=os.path.split(lp)[-1].split(&#39;-&#39;)[0]</span>
        
    <span class="k">def</span> <span class="nf">initialize_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">!=</span><span class="p">[]:</span>
            <span class="n">so</span><span class="o">=</span><span class="n">scorer</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">=</span><span class="n">optimizer</span><span class="p">(</span><span class="n">scorer</span><span class="o">=</span><span class="n">so</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;testperc&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">testperc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;testperc&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;testsample&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">testsample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;testsample&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="p">:</span>
            <span class="c">#self.ospsfo=optimizer(scorer=self.spsfo.scorer)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">get_sample</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">model</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="o">=</span><span class="p">[]</span>
            
    <span class="k">def</span> <span class="nf">cross_validation_single_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">input</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">cross_validation_single_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">input</span><span class="p">):</span>
        <span class="n">k</span><span class="o">=</span><span class="nb">input</span><span class="p">[</span><span class="s">&#39;k&#39;</span><span class="p">]</span>
        <span class="n">sample</span><span class="o">=</span><span class="nb">input</span><span class="p">[</span><span class="s">&#39;sample&#39;</span><span class="p">]</span>
        <span class="n">modellist</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">resultlist</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">trainresultlist</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">inputlist</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">parnum</span><span class="o">=</span><span class="mi">2</span>
        <span class="k">if</span> <span class="s">&#39;fold&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
            <span class="n">parnum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;fold&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">):</span>
            <span class="n">samplelist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">partfunc</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="n">parnum</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">parnum</span><span class="p">):</span>
                <span class="n">trainlist</span><span class="o">=</span><span class="p">[]</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">parnum</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">m</span><span class="o">!=</span><span class="n">j</span><span class="p">:</span>
                        <span class="n">trainlist</span><span class="o">=</span><span class="n">trainlist</span><span class="o">+</span><span class="n">samplelist</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>                        
                <span class="n">inputlist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">trainlist</span><span class="p">,</span><span class="n">samplelist</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span>
        <span class="k">if</span> <span class="s">&#39;testsample&#39;</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">:</span>
            <span class="n">inputlist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">sample</span><span class="p">,</span><span class="nb">input</span><span class="p">[</span><span class="s">&#39;testsample&#39;</span><span class="p">]])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputlist</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inputlist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputlist</span><span class="o">+</span><span class="n">inputlist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputlist</span><span class="o">=</span><span class="n">inputlist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_scorer_list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distribute_runs</span><span class="p">()</span>        
        <span class="k">if</span> <span class="s">&quot;initialmodelpath&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_initial_values_from_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;initialmodelpath&#39;</span><span class="p">])</span>
            
    <span class="k">def</span> <span class="nf">get_initial_values_from_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">path</span><span class="o">=</span><span class="p">[</span><span class="n">path</span><span class="p">]</span>
        <span class="n">csp</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">currentpath</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">cvm</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">currentpath</span><span class="p">,</span><span class="s">&#39;cvmodel.pickle&#39;</span><span class="p">)))</span>
            <span class="n">om</span><span class="o">=</span><span class="n">cvm</span><span class="p">[</span><span class="s">&#39;model&#39;</span><span class="p">]</span>
            <span class="c">#if om[&#39;cvk&#39;]!=self.model[&#39;cvk&#39;] or (&#39;fold&#39; in self.model and om[&#39;fold&#39;]!=self.model[&#39;fold&#39;]) or (&#39;testperc&#39; in self.model and om[&#39;testperc&#39;]!=self.model[&#39;testperc&#39;]):</span>
            <span class="c">#    raise Bugs(&#39;Models does not match, can not load the model as initial conditions&#39;)</span>
            <span class="c">#match models How to???        </span>
            <span class="k">if</span> <span class="s">&#39;initialpars&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;initialpars&#39;</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;best&#39;</span><span class="p">:</span>
                <span class="n">parname</span><span class="o">=</span><span class="s">&#39;bestrepna&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parname</span><span class="o">=</span><span class="s">&#39;repna&#39;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cvm</span><span class="p">[</span><span class="s">&#39;allresult&#39;</span><span class="p">])</span><span class="o">&lt;</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scorerlist</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">):</span>
                <span class="n">rdlist</span><span class="o">=</span><span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scorerlist</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">):</span>
                    <span class="n">k</span><span class="o">=</span><span class="n">i</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">cvm</span><span class="p">[</span><span class="s">&#39;allresult&#39;</span><span class="p">])</span>
                    <span class="n">crd</span><span class="o">=</span><span class="n">cvm</span><span class="p">[</span><span class="s">&#39;allresult&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                    <span class="n">a</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">crd</span><span class="p">[</span><span class="n">parname</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                    <span class="n">crd</span><span class="p">[</span><span class="n">parname</span><span class="p">]</span><span class="o">=</span><span class="n">crd</span><span class="p">[</span><span class="n">parname</span><span class="p">][</span><span class="n">a</span><span class="p">,:]</span>
                    <span class="n">rdlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">crd</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rdlist</span><span class="o">=</span><span class="n">cvm</span><span class="p">[</span><span class="s">&#39;allresult&#39;</span><span class="p">][:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scorerlist</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">]</span>
            <span class="n">oso</span><span class="o">=</span><span class="n">scorer</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">om</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scorerlist</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">):</span>
                <span class="n">repna</span><span class="o">=</span><span class="n">rdlist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">parname</span><span class="p">]</span>
                <span class="n">sp</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">trn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runsperscorer</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="o">/</span><span class="n">repna</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">repna</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">repna</span> <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trn</span><span class="p">)])[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">runsperscorer</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">,:]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">):</span>
                    <span class="n">so</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scorerlist</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">rdlist</span><span class="p">)</span><span class="o">+</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">ep</span><span class="o">=</span><span class="n">sp</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">runsperscorer</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">so</span><span class="o">.</span><span class="n">initialvalues</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">so</span><span class="o">.</span><span class="n">initialvalues</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">runsperscorer</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">parvalues</span><span class="p">)))</span><span class="o">-</span><span class="mi">9999</span>
                    <span class="n">csptemp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_parvalue_from_rf</span><span class="p">(</span><span class="n">so</span><span class="o">.</span><span class="n">initialvalues</span><span class="p">,</span><span class="n">om</span><span class="p">,</span><span class="n">repna</span><span class="p">[</span><span class="n">sp</span><span class="p">:</span><span class="n">ep</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">oso</span><span class="p">,</span><span class="n">sp</span><span class="o">=</span><span class="n">csp</span><span class="p">)</span>
                    <span class="n">sp</span><span class="o">=</span><span class="n">sp</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">runsperscorer</span>
            <span class="n">csp</span><span class="o">=</span><span class="n">csptemp</span>
        <span class="k">print</span> <span class="s">&quot;please check the initialvalue performance&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">initialvalues</span><span class="o">=</span><span class="n">so</span><span class="o">.</span><span class="n">initialvalues</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">get_initial_value</span><span class="p">()</span>
        <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">assess</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">bestpar</span><span class="p">)</span>
                
    <span class="k">def</span> <span class="nf">get_parvalue_from_rf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">newpar</span><span class="p">,</span><span class="n">originalmodel</span><span class="p">,</span><span class="n">originalpar</span><span class="p">,</span><span class="n">oso</span><span class="p">,</span><span class="n">sp</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c">#originalpar is the list containing all the search pars, we need to somehow convert the original pars to the pars for the new model</span>
        <span class="c">#pdb.set_trace()</span>
        <span class="n">parshape</span><span class="o">=</span><span class="n">originalpar</span><span class="o">.</span><span class="n">shape</span>
        <span class="c">#the scorers from the original model and current model are matched 1 by 1.</span>
        <span class="n">ospi</span><span class="o">=</span><span class="mi">0</span> <span class="c"># original model  position</span>
        <span class="k">for</span> <span class="n">spi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;scorers&#39;</span><span class="p">])):</span> <span class="c">#current model posiiotn</span>
            <span class="k">print</span> <span class="n">spi</span>
            <span class="c">#if spi==(len(self.spsfo.scorer.model[&#39;scorers&#39;])-2):</span>
            <span class="c">#    pdb.set_trace()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">scorersearchlist</span><span class="p">[</span><span class="n">spi</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>            
            <span class="n">bins</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">if</span> <span class="s">&#39;par&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;scorers&#39;</span><span class="p">][</span><span class="n">spi</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">parshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">bins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;scorers&#39;</span><span class="p">][</span><span class="n">spi</span><span class="p">][</span><span class="s">&#39;par&#39;</span><span class="p">])</span>            
            <span class="c">#skip original model to the first search position</span>
            <span class="k">while</span> <span class="n">ospi</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">originalmodel</span><span class="p">[</span><span class="s">&#39;scorers&#39;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">oso</span><span class="o">.</span><span class="n">scorersearchlist</span><span class="p">[</span><span class="n">ospi</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ospi</span><span class="o">+=</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">ospi</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">originalmodel</span><span class="p">[</span><span class="s">&#39;scorers&#39;</span><span class="p">]):</span>
                <span class="n">spi</span><span class="o">-=</span><span class="mi">1</span>
                <span class="k">break</span>
            <span class="n">setvalues</span><span class="o">=</span><span class="bp">False</span>
            <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">scorersearchlist</span><span class="p">[</span><span class="n">spi</span><span class="p">]:</span>
                <span class="n">currentsearch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;searches&#39;</span><span class="p">][</span><span class="n">si</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">currentsearch</span><span class="p">[</span><span class="s">&#39;key&#39;</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;ratio&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">si2</span> <span class="ow">in</span> <span class="n">oso</span><span class="o">.</span><span class="n">scorersearchlist</span><span class="p">[</span><span class="n">ospi</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">originalmodel</span><span class="p">[</span><span class="s">&#39;searches&#39;</span><span class="p">][</span><span class="n">si2</span><span class="p">][</span><span class="s">&#39;key&#39;</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;ratio&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">newpar</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">searchlistspos</span><span class="p">[</span><span class="n">si</span><span class="p">]]</span><span class="o">!=-</span><span class="mi">9999</span><span class="p">):</span>
                                <span class="k">print</span> <span class="s">&quot;resetting the values twice&quot;</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">parshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                                <span class="n">newpar</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">searchlistspos</span><span class="p">[</span><span class="n">si</span><span class="p">]]</span><span class="o">=</span><span class="n">originalpar</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">oso</span><span class="o">.</span><span class="n">searchlistspos</span><span class="p">[</span><span class="n">si2</span><span class="p">]]</span>
                            <span class="n">setvalues</span><span class="o">=</span><span class="bp">True</span>
                <span class="k">elif</span> <span class="n">currentsearch</span><span class="p">[</span><span class="s">&#39;key&#39;</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;par&#39;</span><span class="p">:</span>
                    <span class="n">setbins</span><span class="o">=</span><span class="bp">False</span> 
                    <span class="k">for</span> <span class="n">si2</span> <span class="ow">in</span> <span class="n">oso</span><span class="o">.</span><span class="n">scorersearchlist</span><span class="p">[</span><span class="n">ospi</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">originalmodel</span><span class="p">[</span><span class="s">&#39;searches&#39;</span><span class="p">][</span><span class="n">si2</span><span class="p">][</span><span class="s">&#39;key&#39;</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;par&#39;</span> <span class="ow">and</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">searchlistspos</span><span class="p">[</span><span class="n">si</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">searchlistspos</span><span class="p">[</span><span class="n">si</span><span class="p">])</span><span class="o">==</span><span class="p">(</span><span class="n">oso</span><span class="o">.</span><span class="n">searchlistspos</span><span class="p">[</span><span class="n">si2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">oso</span><span class="o">.</span><span class="n">searchlistspos</span><span class="p">[</span><span class="n">si2</span><span class="p">])):</span>
                            <span class="n">setbins</span><span class="o">=</span><span class="bp">True</span>
                            <span class="n">bins</span><span class="o">=</span><span class="p">[]</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">newpar</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">searchlistspos</span><span class="p">[</span><span class="n">si</span><span class="p">]:</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">searchlistspos</span><span class="p">[</span><span class="n">si</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">!=-</span><span class="mi">9999</span><span class="p">):</span>
                                <span class="k">print</span> <span class="s">&quot;resetting the values twice&quot;</span>
                                <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>                            
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">parshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                                <span class="n">newpar</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">searchlistspos</span><span class="p">[</span><span class="n">si</span><span class="p">]:</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">searchlistspos</span><span class="p">[</span><span class="n">si</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">=</span><span class="n">originalpar</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">oso</span><span class="o">.</span><span class="n">searchlistspos</span><span class="p">[</span><span class="n">si2</span><span class="p">]:</span><span class="n">oso</span><span class="o">.</span><span class="n">searchlistspos</span><span class="p">[</span><span class="n">si2</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span>                    
                                <span class="n">bins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">originalpar</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">oso</span><span class="o">.</span><span class="n">searchlistspos</span><span class="p">[</span><span class="n">si2</span><span class="p">]:</span><span class="n">oso</span><span class="o">.</span><span class="n">searchlistspos</span><span class="p">[</span><span class="n">si2</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span> 
                            <span class="n">setvalues</span><span class="o">=</span><span class="bp">True</span>
                    <span class="k">if</span> <span class="n">setbins</span><span class="o">==</span><span class="bp">False</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">originalmodel</span><span class="p">[</span><span class="s">&#39;scorers&#39;</span><span class="p">][</span><span class="n">ospi</span><span class="p">][</span><span class="s">&#39;par&#39;</span><span class="p">])</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;scorers&#39;</span><span class="p">][</span><span class="n">spi</span><span class="p">][</span><span class="s">&#39;par&#39;</span><span class="p">]):</span>
                        <span class="n">bins</span><span class="o">=</span><span class="p">[]</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">newpar</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">searchlistspos</span><span class="p">[</span><span class="n">si</span><span class="p">]:</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">searchlistspos</span><span class="p">[</span><span class="n">si</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">!=-</span><span class="mi">9999</span><span class="p">):</span>
                            <span class="k">print</span> <span class="s">&quot;resetting the values twice&quot;</span>
                            <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>                        
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">parshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                            <span class="n">newpar</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">searchlistspos</span><span class="p">[</span><span class="n">si</span><span class="p">]:</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">searchlistspos</span><span class="p">[</span><span class="n">si</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">=</span><span class="n">originalmodel</span><span class="p">[</span><span class="s">&#39;scorers&#39;</span><span class="p">][</span><span class="n">ospi</span><span class="p">][</span><span class="s">&#39;par&#39;</span><span class="p">]</span>                   
                            <span class="n">bins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">originalmodel</span><span class="p">[</span><span class="s">&#39;scorers&#39;</span><span class="p">][</span><span class="n">ospi</span><span class="p">][</span><span class="s">&#39;par&#39;</span><span class="p">])</span>
                        <span class="n">setvalues</span><span class="o">=</span><span class="bp">True</span>
            <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">scorersearchlist</span><span class="p">[</span><span class="n">spi</span><span class="p">]:</span>
                <span class="n">currentsearch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;searches&#39;</span><span class="p">][</span><span class="n">si</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">currentsearch</span><span class="p">[</span><span class="s">&#39;key&#39;</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;parvalue&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">si2</span> <span class="ow">in</span> <span class="n">oso</span><span class="o">.</span><span class="n">scorersearchlist</span><span class="p">[</span><span class="n">ospi</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">originalmodel</span><span class="p">[</span><span class="s">&#39;searches&#39;</span><span class="p">][</span><span class="n">si2</span><span class="p">][</span><span class="s">&#39;key&#39;</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;parvalue&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">newpar</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">searchlistspos</span><span class="p">[</span><span class="n">si</span><span class="p">]:</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">searchlistspos</span><span class="p">[</span><span class="n">si</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">!=-</span><span class="mi">9999</span><span class="p">):</span>
                                <span class="k">print</span> <span class="s">&quot;resetting the values twice&quot;</span>
                                <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>                            
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">parshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                                <span class="n">oso</span><span class="o">.</span><span class="n">parvalues</span><span class="o">=</span><span class="n">originalpar</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span>
                                <span class="n">oso</span><span class="o">.</span><span class="n">assign_values2model</span><span class="p">()</span>
                                <span class="n">sfmodel</span><span class="o">=</span><span class="n">oso</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;searches&#39;</span><span class="p">][</span><span class="n">si2</span><span class="p">][</span><span class="s">&#39;object&#39;</span><span class="p">]</span>
                                <span class="n">sfo</span><span class="o">=</span><span class="n">sf</span><span class="p">(</span><span class="o">**</span><span class="n">sfmodel</span><span class="p">)</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;scorers&#39;</span><span class="p">][</span><span class="n">spi</span><span class="p">][</span><span class="s">&#39;sftype&#39;</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;bins&#39;</span><span class="p">:</span>
                                    <span class="n">sfo</span><span class="o">.</span><span class="n">bins</span><span class="o">=</span><span class="n">sf</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;scorers&#39;</span><span class="p">][</span><span class="n">spi</span><span class="p">])</span><span class="o">.</span><span class="n">bins</span>
                                    <span class="n">sfv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sfo</span><span class="o">.</span><span class="n">get_sf</span><span class="p">(</span><span class="n">returnreft</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
                                    <span class="n">newpar</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">searchlistspos</span><span class="p">[</span><span class="n">si</span><span class="p">]:</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">searchlistspos</span><span class="p">[</span><span class="n">si</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">=</span><span class="n">sfv</span>                                    
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">sfo</span><span class="o">.</span><span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">+</span><span class="p">[</span><span class="n">sfo</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]]]</span>
                                    <span class="n">sfv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sfo</span><span class="o">.</span><span class="n">get_sf</span><span class="p">(</span><span class="n">returnreft</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
                                    <span class="n">newpar</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">searchlistspos</span><span class="p">[</span><span class="n">si</span><span class="p">]:</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">searchlistspos</span><span class="p">[</span><span class="n">si</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">=</span><span class="n">sfv</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">setvalues</span><span class="o">=</span><span class="bp">True</span>
            <span class="k">if</span> <span class="n">setvalues</span><span class="p">:</span>
                <span class="n">ospi</span><span class="o">+=</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">ospi</span><span class="o">==</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">originalmodel</span><span class="p">[</span><span class="s">&#39;scorers&#39;</span><span class="p">])):</span>
                <span class="k">break</span>            
            <span class="c">#pdb.set_trace()</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">newpar</span><span class="o">==-</span><span class="mi">9999</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">&#39;Some Initial values are undefined &#39;</span>
        <span class="k">print</span> <span class="n">spi</span>
        <span class="n">spi</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">spi</span>
            
    <span class="k">def</span> <span class="nf">distribute_runs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c">#get runs per node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optn</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputlist</span><span class="p">)</span> <span class="c">#total number of trials, number of different sets        </span>
        <span class="n">perruntime</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">dsss</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">sa</span><span class="p">)</span><span class="o">/</span><span class="mf">250000.0</span> <span class="c">#approximate run time in minutes</span>
        <span class="n">optin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;runsperscorer&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runsperscorer</span><span class="o">=</span><span class="n">optin</span>
        <span class="n">rsnf</span><span class="o">=</span><span class="n">optimizerjobtime</span><span class="o">/</span><span class="n">perruntime</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rsnf</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;=</span><span class="n">optin</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runspernode</span><span class="o">=</span><span class="n">optin</span>
        <span class="k">elif</span> <span class="n">rsnf</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">rsnf</span><span class="o">+</span><span class="mi">1</span><span class="p">)),</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">optin</span><span class="o">%</span><span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runspernode</span><span class="o">=</span><span class="n">i</span>
                    <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runspernode</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">optin</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">runspernode</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Make sure the total number of optimization tries is equal to interger * &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runspernode</span><span class="p">))</span>
        <span class="n">rpert</span><span class="o">=</span><span class="n">optin</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">runspernode</span> <span class="c">#number of runs per trail</span>
        <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">rnl</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">rnd</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optn</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withlastone</span> <span class="ow">and</span> <span class="n">i</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">optn</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">rpn</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runspernode</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="c">#</span>
                <span class="k">if</span> <span class="n">rpn</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">rpn</span><span class="o">=</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rpn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runspernode</span>
            <span class="n">rnl</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">rj</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">optin</span><span class="p">),</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">optin</span><span class="o">+</span><span class="mi">1</span><span class="p">)):</span>
                <span class="n">nn</span><span class="o">=</span><span class="n">j</span><span class="o">%</span><span class="n">rpn</span>
                <span class="k">if</span> <span class="n">nn</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span> <span class="c"># run number, sort of series number</span>
                    <span class="n">rnl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">rnd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="p">,[</span><span class="n">rj</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rnd</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nors</span><span class="o">=</span><span class="n">k</span><span class="c">#number of runs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runnumlist</span><span class="o">=</span><span class="n">rnl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runnumdict</span><span class="o">=</span><span class="n">rnd</span>
        
    <span class="k">def</span> <span class="nf">get_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelinlog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">afterprocessing</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span><span class="n">preparing</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span>
    
    <span class="k">def</span> <span class="nf">prepare_cross_validation_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span>
        <span class="c">#should call this function to do cross validation under every circustance</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;repeat&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;repeat&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">testperc</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">testsample</span><span class="p">,</span><span class="n">trainsample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_test_sample</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">testperc</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">testsample</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">testsample</span><span class="o">=</span><span class="n">testsample</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trainsample</span><span class="o">=</span><span class="n">trainsample</span>
                <span class="nb">input</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;k&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;cvk&#39;</span><span class="p">],</span><span class="s">&#39;sample&#39;</span><span class="p">:</span><span class="n">trainsample</span><span class="p">,</span><span class="s">&#39;testsample&#39;</span><span class="p">:</span><span class="n">testsample</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">withlastone</span><span class="o">=</span><span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">input</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;k&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;cvk&#39;</span><span class="p">],</span><span class="s">&#39;sample&#39;</span><span class="p">:</span><span class="n">sample</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">withlastone</span><span class="o">=</span><span class="bp">False</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cross_validation_single_model</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="c">#pdb.set_trace()</span>
        <span class="c">#preparing task object</span>

    <span class="k">def</span> <span class="nf">cross_validation_with_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_task</span><span class="p">()</span>
        <span class="n">tasklist</span><span class="p">(</span><span class="n">tasklist</span><span class="o">=</span><span class="p">[</span><span class="n">to</span><span class="p">])</span><span class="o">.</span><span class="n">monitor2end</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">runtask_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inputcode</span><span class="p">):</span>
        <span class="c">#the individual nodes on the cluster will run this function, if other funtions needs to be run here, chage the code here.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rid</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">inputcode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">=</span><span class="s">&#39;./&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runpath</span><span class="o">=</span><span class="n">runenv</span><span class="o">.</span><span class="n">basedir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputcode</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">inputcode</span><span class="p">)</span>
        <span class="n">inputindex</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runnumdict</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputcode</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runstatus</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runnumlist</span><span class="p">[</span><span class="n">inputindex</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scorerlist</span><span class="p">[</span><span class="n">inputindex</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testscorer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scorerlist</span><span class="p">[</span><span class="n">inputindex</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorerid</span><span class="o">=</span><span class="n">inputindex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">jobid</span><span class="o">=</span><span class="n">inputcode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">runsperscorer</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runnumlist</span><span class="p">[</span><span class="n">inputindex</span><span class="p">])</span>   
        <span class="n">res</span><span class="o">=</span><span class="p">[]</span>
        <span class="c">#initialize the daemon thread array if specified...</span>
        <span class="k">if</span> <span class="s">&#39;thread&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">model</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;thread&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">runenv</span><span class="o">.</span><span class="n">numofthread</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;thread&#39;</span><span class="p">]</span>
            <span class="n">runenv</span><span class="o">.</span><span class="n">setup_threadpool</span><span class="p">()</span>
        <span class="c">#thread pool setup finished</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trainscorer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scorerlist</span><span class="p">[</span><span class="n">inputindex</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testscorer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scorerlist</span><span class="p">[</span><span class="n">inputindex</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runpath</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">inputcode</span><span class="o">+</span><span class="s">&#39;.pickle&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">starttime</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">quit</span><span class="o">=</span><span class="bp">False</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">runnumdict</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputcode</span><span class="p">)][</span><span class="mi">1</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">=</span><span class="n">load_scorer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scorerlist</span><span class="p">[</span><span class="n">inputindex</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">indexlen</span><span class="p">)</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">runtask_local</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">testscorer</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">quit</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">print</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;touch Finished&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorerid</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;#&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">jobid</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;#&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">starttime</span><span class="p">)))</span>
            <span class="k">print</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;touch &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">runpath</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">inputcode</span><span class="o">+</span><span class="s">&#39;.pickle&#39;</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runpath</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">inputcode</span><span class="o">+</span><span class="s">&#39;.pickle&#39;</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">fh</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runnumlist</span><span class="p">[</span><span class="n">inputindex</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputcode</span><span class="p">):</span><span class="c">#last one will collect all the jobs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wait_analyze_single_try</span><span class="p">(</span><span class="n">inputindex</span><span class="p">)</span>
                <span class="c">#oc.dump(self.inputcode+&#39;.optimizer.pickle&#39;)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">runnumlist</span><span class="p">[</span><span class="n">inputindex</span><span class="p">]:</span>
                    <span class="k">print</span> <span class="s">&#39;removing &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">print</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;rm &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;.pickle&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fh</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputcode</span><span class="o">+</span><span class="s">&#39;.optimizer.pickle&#39;</span><span class="p">,</span><span class="s">&#39;wb&#39;</span><span class="p">)</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="s">&#39;Empty&#39;</span><span class="p">,</span><span class="n">fh</span><span class="p">)</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">runsuccess</span><span class="o">=</span><span class="bp">True</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">e</span>
            <span class="k">print</span> <span class="s">&quot;FatalError : can not write the pickle file&quot;</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="n">runsuccess</span><span class="o">=</span><span class="bp">False</span>
        <span class="n">report_job_runstatus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runpath</span><span class="p">,</span> <span class="n">runsuccess</span><span class="p">,</span> <span class="n">inputcode</span><span class="p">,</span> <span class="s">&#39;.optimizer&#39;</span><span class="p">,</span><span class="n">inputname</span><span class="o">=</span><span class="s">&#39;runme.py&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">wait_analyze_single_try</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inputindex</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&#39;waiting for other runs to finish &#39;</span>
        <span class="c">#rn=self.check_status_single_try(inputindex)</span>
        <span class="c">#while rn&gt;0:</span>
        <span class="c">#    time.sleep(10)</span>
        <span class="c">#    rn=self.check_status_single_try(inputindex)</span>
        <span class="c">#    print os.system(&#39;touch &#39;+self.runpath+str(inputindex)+&#39;-waiting-&#39;+str(rn))</span>
        <span class="n">rn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">check_status_single_try</span><span class="p">(</span><span class="n">inputindex</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;jobfinished&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">rn</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="c">#change to rn&gt;1</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
            <span class="n">rn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">check_status_single_try</span><span class="p">(</span><span class="n">inputindex</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;jobfinished&#39;</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&#39;waiting for others to finish&#39;</span>
            <span class="c">#print os.system(&#39;touch &#39;+self.runpath+str(inputindex)+&#39;-waitingjob-&#39;+str(rn))        </span>
        <span class="c">#print os.system(&#39;rm &#39;+self.runpath+str(inputindex)+&#39;-waiting*&#39;)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_results_for_single_try</span><span class="p">(</span><span class="n">inputindex</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_status_single_try</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inputindex</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;pickle&#39;</span><span class="p">):</span>
        <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">fl</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runpath</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ii</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runnumlist</span><span class="p">[</span><span class="n">inputindex</span><span class="p">],</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runnumlist</span><span class="p">[</span><span class="n">inputindex</span><span class="p">]))):</span>
            <span class="k">if</span> <span class="nb">type</span><span class="o">==</span><span class="s">&#39;pickle&#39;</span><span class="p">:</span>
                <span class="n">cfn</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;.pickle&#39;</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="o">==</span><span class="s">&#39;jobfinished&#39;</span><span class="p">:</span>
                <span class="n">cfn</span><span class="o">=</span><span class="s">&#39;jobfinished.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;.optimizer.tar.gz&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runstatus</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="ow">or</span> <span class="n">cfn</span> <span class="ow">in</span> <span class="n">fl</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runstatus</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
                <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
                <span class="c">#print os.system(&#39;touch &#39;+str(inputindex)+&#39;-waitingnum-&#39;+str(i))</span>
        <span class="k">print</span> <span class="s">&quot;Finished run num (&quot;</span><span class="o">+</span><span class="nb">type</span><span class="o">+</span><span class="s">&quot;) :&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runnumlist</span><span class="p">[</span><span class="n">inputindex</span><span class="p">])</span><span class="o">-</span><span class="n">k</span>

    <span class="k">def</span> <span class="nf">analyze_results_for_single_try</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inputindex</span><span class="p">):</span>
        <span class="n">dl</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">brl</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">runnumlist</span><span class="p">[</span><span class="n">inputindex</span><span class="p">]:</span>
            <span class="n">tnt</span><span class="o">=</span><span class="mi">3</span>
            <span class="n">success</span><span class="o">=</span><span class="bp">False</span>
            <span class="k">while</span> <span class="n">tnt</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">tnt</span><span class="o">=</span><span class="n">tnt</span><span class="o">-</span><span class="mi">1</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fh</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runpath</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;.pickle&#39;</span><span class="p">)</span>
                    <span class="n">ndl</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">nd</span> <span class="ow">in</span> <span class="n">ndl</span><span class="p">:</span>
                        <span class="n">dl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nd</span><span class="p">)</span> <span class="c">#result dictionary list</span>
                        <span class="n">brl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nd</span><span class="p">[</span><span class="s">&#39;trainresultlist&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                    <span class="n">success</span><span class="o">=</span><span class="bp">True</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span> 
                    <span class="n">success</span><span class="o">=</span><span class="bp">False</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inputindex</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runnumlist</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">withlastone</span><span class="p">:</span>
            <span class="n">lastone</span><span class="o">=</span><span class="bp">True</span> <span class="c"># whether this is training on the whole set...</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lastone</span><span class="o">=</span><span class="bp">False</span>
        <span class="n">bbr</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">brl</span><span class="p">)</span>
        <span class="n">parlist</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">resultlist</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">testresult</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">pd</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">testresultlist</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">allparlist</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">alltrainresult</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">alltestresult</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">brl</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">brl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="n">bbr</span><span class="p">:</span> <span class="c"># only take runs that has reach &quot;the global minimum&quot;</span>
                <span class="n">parlist</span><span class="o">=</span><span class="n">parlist</span><span class="o">+</span><span class="n">dl</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;parlist&#39;</span><span class="p">]</span>
                <span class="n">resultlist</span><span class="o">=</span><span class="n">resultlist</span><span class="o">+</span><span class="n">dl</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;trainresultlist&#39;</span><span class="p">]</span>
                <span class="n">testresultlist</span><span class="o">=</span><span class="n">testresultlist</span><span class="o">+</span><span class="n">dl</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;testresultlist&#39;</span><span class="p">]</span>
                <span class="n">pd</span><span class="o">=</span><span class="n">pd</span><span class="o">+</span><span class="n">dl</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;PredictiveDensity&#39;</span><span class="p">]</span>
                <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">allparlist</span><span class="o">=</span><span class="n">allparlist</span><span class="o">+</span><span class="n">dl</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;parlist&#39;</span><span class="p">]</span>
            <span class="n">alltrainresult</span><span class="o">=</span><span class="n">alltrainresult</span><span class="o">+</span><span class="n">dl</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;trainresultlist&#39;</span><span class="p">]</span>
            <span class="c">#alltestresult=alltestresult+dl[i][&#39;testresultlist&#39;]            </span>
        <span class="c">#get representative pars</span>
        <span class="n">allna</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">allparlist</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">alltrainresult</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alltrainresult</span><span class="p">),</span><span class="mi">1</span><span class="p">)])</span>
        <span class="c">#bestrepna=get_representative_pars_forbest(allna,maxcluster=400,cutoffdistance=0.0000001,clusteringperc=0.999, othermaxnumber=0)</span>
        <span class="c">#repna=get_representative_pars_forbest(allna,maxcluster=400,cutoffdistance=0.0000001,clusteringperc=0.5, othermaxnumber=0)</span>
        <span class="n">plna</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">parlist</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plna</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">resultlist</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">bestpar</span><span class="o">=</span><span class="n">plna</span>
            <span class="n">bestresult</span><span class="o">=</span><span class="n">resultlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ra</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">resultlist</span><span class="p">)</span>
            <span class="n">plnam</span><span class="o">=</span><span class="n">plna</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">plnas</span><span class="o">=</span><span class="n">plna</span><span class="p">[</span><span class="n">ra</span><span class="o">==</span><span class="n">ra</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plna</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">plnad</span><span class="o">=</span><span class="p">(((</span><span class="n">plnas</span><span class="o">-</span><span class="n">plnam</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plnad</span><span class="o">=</span><span class="p">(((</span><span class="n">plnas</span><span class="o">-</span><span class="n">plnam</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>            
            <span class="n">mindex</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">plnad</span><span class="p">)</span>
            <span class="n">bestpar</span><span class="o">=</span><span class="n">plnas</span><span class="p">[</span><span class="n">mindex</span><span class="p">]</span>
            <span class="n">bestresult</span><span class="o">=</span><span class="n">ra</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">ta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">testresultlist</span><span class="p">)</span>
        <span class="n">ta</span><span class="o">=-</span><span class="p">(</span><span class="n">ta</span><span class="o">-</span><span class="n">dl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;idealresult&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;std&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">tamax</span><span class="o">=</span><span class="n">ta</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">rlpd</span><span class="o">=</span><span class="n">tamax</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ta</span><span class="o">-</span><span class="n">tamax</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">testresultlist</span><span class="p">))</span>
        <span class="n">finalbestresult</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">if</span> <span class="s">&#39;finalcriteria&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;bmtype&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">=</span><span class="n">load_scorer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trainscorer</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">indexlen</span><span class="p">)</span>
            <span class="n">finalbestresult</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">assess</span><span class="p">(</span><span class="n">bestpar</span><span class="p">,</span><span class="n">slevel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;bmtype&#39;</span><span class="p">][</span><span class="s">&#39;finalcriteria&#39;</span><span class="p">])</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span>            
        <span class="n">testscorer</span><span class="o">=</span><span class="n">load_scorer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testscorer</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">indexlen</span><span class="p">)</span>
        <span class="n">finaltestresult</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">if</span> <span class="s">&#39;finalcriteria&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;bmtype&#39;</span><span class="p">]:</span>
            <span class="n">finaltestresult</span><span class="o">=</span><span class="n">testscorer</span><span class="o">.</span><span class="n">assess</span><span class="p">(</span><span class="n">bestpar</span><span class="p">,</span><span class="n">slevel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;bmtype&#39;</span><span class="p">][</span><span class="s">&#39;finalcriteria&#39;</span><span class="p">])</span>
        <span class="n">sd</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;lastone&#39;</span><span class="p">:</span><span class="n">lastone</span><span class="p">,</span><span class="c">#&#39;parlist&#39;:parlist,&#39;resultlist&#39;:resultlist,&#39;testresultlist&#39;:testresultlist,</span>
            <span class="s">&#39;bestpar&#39;</span><span class="p">:</span><span class="n">bestpar</span><span class="p">,</span> <span class="s">&#39;bestresult&#39;</span><span class="p">:</span><span class="n">resultlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&#39;testresult&#39;</span><span class="p">:</span><span class="n">testscorer</span><span class="o">.</span><span class="n">assess</span><span class="p">(</span><span class="n">bestpar</span><span class="p">),</span>
            <span class="s">&#39;fulltestresult&#39;</span><span class="p">:</span><span class="n">testscorer</span><span class="o">.</span><span class="n">assess</span><span class="p">(</span><span class="n">bestpar</span><span class="p">,</span><span class="n">report</span><span class="o">=</span><span class="s">&#39;full&#39;</span><span class="p">),</span> <span class="s">&#39;allna&#39;</span><span class="p">:</span><span class="n">allna</span>
            <span class="p">,</span><span class="s">&#39;pd&#39;</span><span class="p">:</span><span class="n">pd</span><span class="o">/</span><span class="n">k</span><span class="p">,</span><span class="s">&#39;rlpd&#39;</span><span class="p">:</span><span class="n">rlpd</span><span class="p">,</span><span class="s">&#39;finalbestresult&#39;</span><span class="p">:</span><span class="n">finalbestresult</span><span class="p">,</span><span class="s">&#39;finaltestresult&#39;</span><span class="p">:</span><span class="n">finaltestresult</span><span class="p">}</span>
        <span class="n">fh</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputcode</span><span class="o">+</span><span class="s">&#39;.optimizer.pickle&#39;</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span><span class="n">fh</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">prepare_task_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_cross_validation_sample</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">=</span><span class="n">runenv</span><span class="o">.</span><span class="n">runs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">get_sn</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rundir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">rsn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runpath</span><span class="o">=</span><span class="n">runenv</span><span class="o">.</span><span class="n">serverUserPath</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">rundir</span><span class="o">+</span><span class="s">&#39;/&#39;</span>
        <span class="c">#self.task=task(&#39;&#39;,&#39;&#39;,afterprocessing=self,preparing=self)        </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">rundir</span><span class="o">+</span><span class="s">&#39;/&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">rdirname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rundir</span>
        <span class="c">#return self.task</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;rm -r &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">rundir</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rundir</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">rundir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>          
        <span class="n">freememory</span><span class="o">=</span><span class="mf">0.5</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">arraysize</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">get_runmemory_percentage</span><span class="p">()</span><span class="o">/</span><span class="mf">1000000000.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freememory</span><span class="o">=</span><span class="n">freememory</span>
        <span class="c">#if self.spsfo.arraysize&gt;50000000:</span>
        <span class="c">#    self.task.queues=&#39;-q lab.q&#39;</span>
        <span class="n">nors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nors</span>
        <span class="c">#write the input list for different runs</span>
        <span class="n">inputlist</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;inputlist&#39;</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">inputlist</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;runme.py&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nors</span><span class="o">+</span><span class="mi">1</span><span class="p">)]))</span>
        <span class="n">inputlist</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">makemdt</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;runme.py&#39;</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">makemdt</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;keeptry=5</span><span class="se">\n</span><span class="s">while keeptry:</span><span class="se">\n</span><span class="s">    try:</span><span class="se">\n</span><span class="s">        from SOAP import *</span><span class="se">\n</span><span class="s">        keeptry=0</span><span class="se">\n</span><span class="s">    except:</span><span class="se">\n</span><span class="s">        keeptry-=1</span><span class="se">\n</span><span class="s">&#39;</span>
                      <span class="o">+</span><span class="s">&#39;import sys </span><span class="se">\n</span><span class="s"> </span><span class="se">\n</span><span class="s">spopt=k2cvcluster()</span><span class="se">\n</span><span class="s">&#39;</span>
                      <span class="o">+</span><span class="s">&#39;spopt.freememory=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">freememory</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
                      <span class="o">+</span><span class="s">&#39;spopt.rsn=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">rsn</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
                      <span class="o">+</span><span class="s">&#39;spopt=spopt.load()</span><span class="se">\n</span><span class="s">&#39;</span>
                      <span class="o">+</span><span class="s">&#39;spopt.runtask_cluster(sys.argv[1])&#39;</span><span class="p">)</span>
        <span class="n">makemdt</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;bmtype&#39;</span><span class="p">][</span><span class="s">&#39;type&#39;</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;sprefine&#39;</span><span class="p">:</span>
            <span class="n">parallel</span><span class="o">=</span><span class="mi">8</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parallel</span><span class="o">=</span><span class="bp">False</span>
        <span class="c">#if self.freememory&gt;20:#this is only necessary when lots of people request memory but not used</span>
            <span class="c">#generate_job_submit_script(0.2,self.rundir,runtime,nors,mem_total=10)</span>
        <span class="c">#else:</span>
        <span class="n">additional_resources</span><span class="o">=</span><span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="s">&#39;thread&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">model</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;thread&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">parallel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="s">&#39;thread&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">freememory</span><span class="o">&gt;</span><span class="mi">10</span><span class="p">:</span>
                <span class="n">additional_resources</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">#$ -l hostname=ih*|xe5520=true</span><span class="se">\n</span><span class="s">#$ -q lab.q</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parallel</span><span class="p">:</span>
            <span class="n">dp</span><span class="o">=</span><span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dp</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">parallel</span><span class="p">)</span>
        <span class="n">generate_job_submit_script</span><span class="p">(</span><span class="n">freememory</span><span class="o">/</span><span class="n">dp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">rundir</span><span class="p">,</span><span class="n">runtime</span><span class="p">,</span><span class="n">nors</span><span class="p">,</span><span class="n">parallel</span><span class="o">=</span><span class="n">parallel</span><span class="p">,</span><span class="n">additional_resources</span><span class="o">=</span><span class="n">additional_resources</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">get_runmemory_percentage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ml</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scorerlist</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="n">sp</span><span class="p">:</span>
                <span class="n">nindexlist</span><span class="o">=</span><span class="n">squeeze_indexlist</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">dsss</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">indexlist</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nindexlist</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">nindexlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">ml</span><span class="p">:</span>
                    <span class="n">ml</span><span class="o">=</span><span class="n">nindexlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ml</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">indexlen</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">afterprocessing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">rundir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="o">=</span><span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">optn</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optn</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">inputn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">runnumlist</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">inputn</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;.optimizer.pickle&#39;</span><span class="p">):</span>
                    <span class="n">fh</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">inputn</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;.optimizer.pickle&#39;</span><span class="p">,</span><span class="s">&#39;rb&#39;</span><span class="p">)</span>
                    <span class="n">res</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">res</span><span class="o">==</span><span class="s">&#39;Empty&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">res</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">rdll</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">nrdlist</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">srn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optn</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">):</span>
                <span class="n">rdll</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="p">[</span><span class="n">srn</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="n">srn</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">originalresult</span><span class="o">=</span><span class="n">rdll</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">srn</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot;num&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">bestresult</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="c">#choose the best train restult</span>
                <span class="k">print</span> <span class="n">bestresult</span>
                <span class="n">bestrd</span><span class="o">=</span><span class="p">[]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">rdll</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;bestresult&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">bestresult</span><span class="p">:</span>
                        <span class="n">bestresult</span><span class="o">=</span><span class="n">rdll</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;bestresult&#39;</span><span class="p">]</span>
                        <span class="k">print</span> <span class="n">bestresult</span>
                        <span class="n">bestrd</span><span class="o">=</span><span class="n">rdll</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">nrdlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bestrd</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="o">=</span><span class="n">nrdlist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">originalresult</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="p">)):</span>
            <span class="n">rd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>    
            <span class="n">allnalist</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">arl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">originalresult</span><span class="p">:</span>
                <span class="n">allnalist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arl</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;allna&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bestrepna</span><span class="o">=</span><span class="n">get_representative_pars_forbest</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">allnalist</span><span class="p">),</span><span class="n">maxcluster</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span><span class="n">cutoffdistance</span><span class="o">=</span><span class="mf">0.0000001</span><span class="p">,</span><span class="n">clusteringperc</span><span class="o">=</span><span class="mf">0.999</span><span class="p">,</span> <span class="n">othermaxnumber</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">repna</span><span class="o">=</span><span class="n">get_representative_pars_forbest</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">allnalist</span><span class="p">),</span><span class="n">maxcluster</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span><span class="n">cutoffdistance</span><span class="o">=</span><span class="mf">0.0000001</span><span class="p">,</span><span class="n">clusteringperc</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">othermaxnumber</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">rd</span><span class="p">[</span><span class="s">&#39;bestrepna&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">bestrepna</span>
                <span class="n">rd</span><span class="p">[</span><span class="s">&#39;repna&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">repna</span>
        <span class="c">#pdb.set_trace()</span>
        <span class="c">#self.clusters=cvclustering([],[],[],clustermethod=self.model[&#39;clustermethod&#39;])</span>
        <span class="c">#self.clusters.optclusterlist=optclusterlist</span>
        <span class="c">#self.clusters.optclusterlist[-1].optscorer=self.scorerlist[-1][0]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyze_clustering_results</span><span class="p">()</span>
        <span class="n">cvresult</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">save_optimization_results</span><span class="p">()</span>
        <span class="k">print</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;rm -r &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">rundir</span><span class="p">)</span>
        <span class="c">#del self.clusters</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">cvresult</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">arraysize</span><span class="o">=</span><span class="n">mypickle</span><span class="p">()</span><span class="o">.</span><span class="n">dump</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">spsfo</span><span class="o">.</span><span class="n">scorer</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">scorerlist</span><span class="p">],</span><span class="s">&#39;input&#39;</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;input.pickle&#39;</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fh</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c"># the scorer object will be useless unlesed the savednumpy is loaded from numpy arrays.</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runpath</span><span class="p">)</span>
        <span class="c">#fm=get_system_freemem()</span>
        <span class="c">#if fm/1000.0&lt;self.freememory:</span>
        <span class="c">#    sys.exit(0)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">freememory</span><span class="o">&lt;</span><span class="mi">20</span> <span class="ow">or</span> <span class="n">runenv</span><span class="o">.</span><span class="n">hostn</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mypickle</span><span class="p">()</span><span class="o">.</span><span class="n">loadpickleonly</span><span class="p">(</span><span class="s">&#39;input&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">runenv</span><span class="o">.</span><span class="n">hostn</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rid</span><span class="o">*</span><span class="mf">0.2</span><span class="p">)</span>
                <span class="n">fl</span><span class="o">=</span><span class="n">get_starting_jobs</span><span class="p">()</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                    <span class="k">print</span> <span class="s">&quot;jobs are starting on  &quot;</span><span class="o">+</span><span class="n">hcn</span>
                <span class="n">fm</span><span class="o">=</span><span class="n">get_system_freemem</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">fm</span><span class="o">/</span><span class="mf">1000.0</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freememory</span><span class="o">+</span><span class="mf">1.5</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">mypickle</span><span class="p">()</span><span class="o">.</span><span class="n">loadpickleonly</span><span class="p">(</span><span class="s">&#39;input&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;not enough free memory on node&quot;</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_ppdock_plotdata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ara</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">30</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scorerlist</span><span class="p">),</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scorerlist</span><span class="p">)):</span>
            <span class="n">ts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scorerlist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">vs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scorerlist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">so</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ts</span><span class="p">,</span><span class="n">vs</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">so</span><span class="o">.</span><span class="n">loadfilter</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
                    <span class="n">so</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">loadfilter</span><span class="p">)</span>
                <span class="n">so</span><span class="o">.</span><span class="n">loadfilter</span><span class="o">=</span><span class="bp">None</span>
                <span class="n">par</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rdlist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;bestpar&#39;</span><span class="p">]</span>
                <span class="n">tnr</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">30</span><span class="p">)</span>
                <span class="k">print</span> <span class="n">so</span><span class="o">.</span><span class="n">assess</span><span class="p">(</span><span class="n">par</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">tnr</span><span class="p">:</span>
                    <span class="n">tcp</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="mf">10.0</span><span class="p">))</span>
                    <span class="n">ara</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">so</span><span class="o">.</span><span class="n">assess</span><span class="p">(</span><span class="n">par</span><span class="p">,</span><span class="n">slevel</span><span class="o">=</span><span class="s">&#39;top&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tcp</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;__nonempty_rmsd10ORirmsd4FIRST&#39;</span><span class="p">)</span>
                <span class="n">k</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">ara</span>

    <span class="k">def</span> <span class="nf">generate_potential</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        
        <span class="n">so</span><span class="o">=</span><span class="n">scorer</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&#39;finaloptpar&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_fromlogdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logpath</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">so</span><span class="o">.</span><span class="n">assess</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finaloptpar</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">so</span><span class="o">.</span><span class="n">assess_model</span><span class="p">()</span>
        <span class="n">rp</span><span class="o">=</span><span class="n">so</span><span class="o">.</span><span class="n">write_potential</span><span class="p">(</span><span class="n">filetype</span><span class="o">=</span><span class="s">&#39;lib&#39;</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">rp</span>
        <span class="n">libpath</span><span class="o">=</span><span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;.opt.lib&#39;</span>
        <span class="k">print</span> <span class="n">libpath</span>
        <span class="k">print</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;scp &#39;</span><span class="o">+</span><span class="n">libpath</span><span class="o">+</span><span class="s">&#39; &#39;</span><span class="o">+</span><span class="n">runenv</span><span class="o">.</span><span class="n">jobserver</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">runenv</span><span class="o">.</span><span class="n">serverUserPath</span><span class="o">+</span><span class="s">&#39;lib&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">rundir</span><span class="o">+</span><span class="s">&#39;.lib&#39;</span><span class="p">))</span>
        
                
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">SOAP 0.1 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Guangqiang Dong.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>